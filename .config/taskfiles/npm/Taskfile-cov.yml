---
version: '3'

tasks:
  all:
    cmds:
      - task: :npm:build:all
      - task: :npm:test:unit
      - task: report

  check:
    deps:
      - :install:modules:local
      - :install:npm:nyc
    log:
      start: Running `nyc report` and `nyc check-coverage`
      success: Finished running `nyc`
      error: Errors encountered while running `nyc report` and `nyc check-coverage`
    cmds:
      - '{{.NPX_HANDLE}}nyc report'
      - '{{.NPX_HANDLE}}nyc check-coverage --lines 100 --functions 100 --branches 100'

  html:
    deps:
      - :install:modules:local
      - :install:npm:nyc
    log:
      start: Reporting with `nyc` in HTML format
      success: Report generated by `nyc` in HTML format
      error: Error while generating HTML report with `nyc`
    cmds:
      - '{{.NPX_HANDLE}}nyc report --reporter=html'

  lcov:
    deps:
      - :install:modules:local
      - :install:npm:nyc
    log:
      start: Reporting with `nyc` in `lcov` format
      success: Finished `lcov` report with `nyc`
      error: Encountered error generating `lcov` report with `nyc`
    cmds:
      - '{{.NPX_HANDLE}}nyc report --reporter=lcov'

  open:
    deps:
      - html
      - :npm:install:open-cli
    desc: Ensures the code coverage report is generated and opens it in a browser
    log:
      start: Opening `coverage/index.html` with the default browser
    cmds:
      - '{{.NPX_HANDLE}}open-cli coverage/index.html'

  report:
    deps:
      - html
      - lcov

  upload:
    deps:
      - lcov
      - :install:npm:codecov
    desc: Uploads code coverage report to `codecov.io`
    log:
      start: Running `codecov`
      success: Successfully ran `codecov`
      error: Error while running `codecov`
    cmds:
      - '{{.NPX_HANDLE}}codecov'
